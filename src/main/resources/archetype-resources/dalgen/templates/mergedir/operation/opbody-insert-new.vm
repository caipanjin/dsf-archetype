#set( $symbol_pound = '#' )
#set( $symbol_dollar = '$' )
#set( $symbol_escape = '\' )
{
${symbol_pound}if (${symbol_dollar}{operation.paramType} == "object")
    	if (${symbol_dollar}{operation.param.name} == null) {
    		throw new IllegalArgumentException("Can't insert a null data object into db.");
    	}
         ${symbol_pound}${symbol_pound}//获得mapping语句 
        ${symbol_pound}${symbol_pound}String oriSql = "${symbol_dollar}{operation.mappedStatementSql}"; 
${symbol_pound}if(${symbol_dollar}{table.getTableConfig().bConfidentiality()} == true)
        //机密性保护操作
        getConfResultForInsert(${symbol_dollar}{operation.param.name});
${symbol_pound}end
${symbol_pound}if(${symbol_dollar}{table.getTableConfig().bIntegrity()} == true)
	    //完整性保护
		getIntegResultForInsert(${symbol_dollar}{operation.param.name});
${symbol_pound}end    
 
	    getSqlMapClientTemplate().insert("${symbol_dollar}{operation.mappedStatementId}", ${symbol_dollar}{operation.param.name});

        return ${symbol_dollar}{operation.param.name}.${symbol_dollar}{table.iwPkColumn.getterName}();
${symbol_pound}else
${symbol_pound}${symbol_pound} Not supported yet.
${symbol_pound}parse ("operation/not-support.vm")
${symbol_pound}end
}   
${symbol_pound}if(${symbol_dollar}{table.getTableConfig().bIntegrity()} == true)
       /**
       * 插入操作的完整性保护方法
       * @param student
       */
     private void getIntegResultForInsert(${symbol_dollar}{table.getQualifiedDOClassName()} ${symbol_dollar}{operation.param.name}) {

		//要生成摘要字段的内容
		String integritymes = ${symbol_dollar}{operation.param.name}.get${symbol_dollar}{finalI}();
		if (integritymes == null || integritymes.length() == 0) {
		   logger.warn("要生成摘要字段数值为空，请确认");
		   throw new IllegalArgumentException("要生成摘要字段数值为空，请确认");
		}
		
	    //kmi处取密钥 
	    KmiResult keyresult2 = methodUtils.getKmiResultInteg(abstractKeyName,appName,0);
		//将数值转化为byte
		byte[] confBytes = integritymes.getBytes();
		//从kmi处取得的密钥是Base64的密文，故解密
		byte[] keyBytes = Base64.decode(keyresult2.getKeyData());
		
		byte[] cipherBytes = null;
		String abstractValue = null;
		//加密
		try {
			cipherBytes = CalculateMacUtil.calMac(confBytes, keyBytes, "HmacSHA256");
			//对摘要字段进行Base64编码
		    abstractValue = Base64.encode(cipherBytes);
		} catch (GeneralSecurityException e) {
			logger.error("加密出现异常");
			throw new RuntimeException("插入数据时完整性加密出错",e);
		}
		
        StringBuffer sb = new StringBuffer();
		//存储的加密字段为密文@version
		String abstractFinalValue = sb.append(abstractValue).append("@").append(abstractKeyName).append("${symbol_pound}").append(keyresult2.getVersion()).toString();
		${symbol_dollar}{operation.param.name}.set${symbol_dollar}!{method2_getInteg}(abstractFinalValue);
       }
${symbol_pound}end


${symbol_pound}if(${symbol_dollar}{table.getTableConfig().bConfidentiality()} == true)
      /**
       * 插入操作的机密性保护方法
       * @param student
       */
      private void getConfResultForInsert(${symbol_dollar}{table.getQualifiedDOClassName()} ${symbol_dollar}{operation.param.name}) {

		//获得要加密字段的数值
	    String confidentialitymes = ${symbol_dollar}{operation.param.name}.get${symbol_dollar}{finalRet}();
	    if (confidentialitymes == null || confidentialitymes.length() == 0) {
		   logger.warn("要加密字段数值为空，请确认");
		   throw new IllegalArgumentException("要加密字段数值为空，请确认");
		}
		//kmi处取密钥 
	    KmiResult keyResult = methodUtils.getKmiResultConf(encodeKeyName,appName,0);
		//将数值转化为byte
		byte[] confBytes = confidentialitymes.getBytes();
		//从kmi处取得的密钥是Base64的密文，故解密
		byte[] keyBytes = Base64.decode(keyResult.getKeyData());
		
		byte[] cipherBytes = null;
		String encodedValue = null;
		//加密
		try {
			cipherBytes = SymmtricCryptoUtil.symmtricCrypto(confBytes, keyBytes, "AES", Cipher.ENCRYPT_MODE);
			//对加密数据进行Base64编码
		    encodedValue = Base64.encode(cipherBytes);
		} catch (GeneralSecurityException e) {
			logger.error("加密出现异常");
			throw new RuntimeException("插入数据时机密性加密出错",e);
		}
		StringBuffer sb = new StringBuffer();
		//存储的加密字段为密文@version
		String finalValue = sb.append(encodedValue).append("@").append(encodeKeyName).append("${symbol_pound}").append(keyResult.getVersion()).toString();				
		${symbol_dollar}{operation.param.name}.set${symbol_dollar}!{method_getConf}(finalValue);
	   }
${symbol_pound}end